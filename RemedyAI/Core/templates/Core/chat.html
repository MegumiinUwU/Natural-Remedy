{% extends 'Core/base_core.html' %}
{% load static %}

{% block core_content %}
<div class="row h-100">
    <div class="col-12">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">{% if is_new %}New Conversation{% else %}{{ conversation.title }}{% endif %}</h5>
            </div>
            <div class="card-body chat-messages" id="chat-messages" style="height: calc(100vh - 250px); overflow-y: auto;">
                {% if is_new %}
                    <!-- Welcome message -->
                    <div class="chat-message bot">
                        <div class="chat-avatar">
                            <img src="{% static 'images/bot-avatar.png' %}" alt="Bot">
                        </div>
                        <div class="chat-bubble">
                            <p>Hello! I'm your Natural Remedy Assistant. How can I help you today?</p>
                            <p>You can describe your symptoms or ask about natural remedies, and I'll suggest appropriate herbs and treatments.</p>
                        </div>
                    </div>
                {% else %}
                    {% for message in messages %}
                    <div class="chat-message {{ message.sender }}">
                        <div class="chat-avatar">
                            <img src="{% static 'images/'|add:message.sender|add:'-avatar.png' %}" alt="{{ message.sender|title }}">
                        </div>
                        <div class="chat-bubble">
                            <p>{{ message.content }}</p>
                            <small class="text-muted">{{ message.timestamp|time:"H:i" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="card-footer bg-white p-3 border-top">
                <form id="chat-form" class="d-flex">
                    {% csrf_token %}
                    <input type="text" id="user-input" class="form-control me-2" placeholder="Type your message here..." required>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .chat-message {
        display: flex;
        margin-bottom: 1rem;
    }
    
    .chat-message.user {
        flex-direction: row-reverse;
    }
    
    .chat-avatar {
        width: 40px;
        height: 40px;
        margin-right: 10px;
        flex-shrink: 0;
    }
    
    .chat-message.user .chat-avatar {
        margin-right: 0;
        margin-left: 10px;
    }
    
    .chat-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
    }
    
    .chat-bubble {
        background: #f0f2f5;
        border-radius: 18px;
        padding: 10px 15px;
        max-width: 75%;
        position: relative;
    }
    
    .chat-message.bot .chat-bubble {
        background: #e9f5e9;
    }
    
    .chat-message.user .chat-bubble {
        background: #e3f2fd;
    }
    
    .chat-bubble p:last-child {
        margin-bottom: 0;
    }
    
    .chat-bubble small {
        position: absolute;
        bottom: 3px;
        right: 10px;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // {% if conversation %}
        let conversationId = "{{ conversation.id|default:'' }}";
        conversationId = conversationId === "" ? null : conversationId;
        // {% endif %}
        
        // Scroll to bottom of chat on load
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = userInput.value.trim();
            if (!message) return;
            
            // Add user message to UI immediately
            addMessage(message, 'user', new Date().toTimeString().slice(0, 5));
            userInput.value = '';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Add typing indicator
            addTypingIndicator();
            
            console.log("Sending message:", message);
            console.log("Conversation ID:", conversationId);
            
            // Send message to server using fetch API
            fetch('{% url "Core:send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId
                })
            })
            .then(response => {
                console.log("Response status:", response.status);
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.status === 'success') {
                    // Update conversation ID if this is a new conversation
                    if (!conversationId) {
                        conversationId = data.conversation_id;
                        console.log("New conversation created with ID:", conversationId);
                        
                        // Update URL to include conversation ID
                        history.pushState(null, '', `/core/chat/${conversationId}/`);
                    }
                    
                    // Add bot response to UI
                    addMessage(data.bot_response, 'bot', data.timestamp);
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    console.error("Error from server:", data.message);
                    addSystemMessage("Sorry, there was an error processing your request.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                removeTypingIndicator();
                addSystemMessage("Sorry, there was a network error. Please try again.");
            });
        });
        
        function addMessage(text, sender, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const avatarImage = sender === 'user' 
                ? "{% static 'images/user-avatar.png' %}" 
                : "{% static 'images/bot-avatar.png' %}";
            
            messageDiv.innerHTML = `
                <div class="chat-avatar">
                    <img src="${avatarImage}" alt="${sender === 'user' ? 'You' : 'Bot'}">
                </div>
                <div class="chat-bubble">
                    <p>${text}</p>
                    <small class="text-muted">${time}</small>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
        }
        
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-warning mx-4 my-2 text-center';
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
        }
        
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="chat-avatar">
                    <img src="{% static 'images/bot-avatar.png' %}" alt="Bot">
                </div>
                <div class="chat-bubble">
                    <p><span class="typing-dots"><span>.</span><span>.</span><span>.</span></span></p>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
    });
</script>
<style>
    .typing-dots span {
        opacity: 0;
        animation: typingDot 1.4s infinite;
        animation-fill-mode: forwards;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typingDot {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }
</style>
{% endblock %}