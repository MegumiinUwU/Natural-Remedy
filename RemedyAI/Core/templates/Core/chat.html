{% extends 'Core/base_core.html' %}
{% load static %}

{% block core_content %}
<div class="flex flex-col h-[calc(100vh-260px)]">
    <div class="flex-shrink-0 border-b border-gray-100 pb-4 mb-4">
        <h5 class="text-xl font-bold text-[#1B5E20]">{% if is_new %}New Conversation{% else %}{{ conversation.title }}{% endif %}</h5>
    </div>
    
    <div class="flex-1 overflow-y-auto mb-4 pr-2 space-y-6" id="chat-messages">
        {% if is_new %}
            <!-- Welcome message -->
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                    <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                </div>
                <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                    <p class="text-[#1B5E20]">Hello! I'm your Natural Remedy Assistant. How can I help you today?</p>
                    <p class="text-[#388E3C] mt-2">You can describe your symptoms or ask about natural remedies, and I'll suggest appropriate herbs and treatments.</p>
                </div>
            </div>
        {% else %}
            {% for message in messages %}
                <div class="flex items-start {% if message.sender == 'user' %}justify-end{% endif %} space-x-3">
                    {% if message.sender == 'bot' %}
                        <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                            <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                        </div>
                        <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                            <p class="text-[#1B5E20]">{{ message.content }}</p>
                            <span class="text-xs text-gray-500 mt-1 block">{{ message.timestamp|time:"H:i" }}</span>
                        </div>
                    {% else %}
                        <div class="bg-[#E3F2FD] rounded-2xl p-4 max-w-[80%]">
                            <p class="text-[#1565C0]">{{ message.content }}</p>
                            <span class="text-xs text-gray-500 mt-1 block">{{ message.timestamp|time:"H:i" }}</span>
                        </div>
                        <div class="flex-shrink-0 bg-[#E3F2FD] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                            <i data-lucide="user" class="h-6 w-6 text-[#1565C0]"></i>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    </div>
    
    <div class="flex-shrink-0 border-t border-gray-100 pt-4 mt-auto">
        <form id="chat-form" class="flex items-center gap-2">
            {% csrf_token %}
            <div class="relative flex-1">
                <input type="text" id="user-input" class="w-full px-5 py-3 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#43A047] pr-12" 
                       placeholder="Type your message here..." required>
                <button type="submit" class="absolute right-1 top-1/2 transform -translate-y-1/2 bg-[#43A047] text-white p-2 rounded-full hover:bg-[#388E3C] transition">
                    <i data-lucide="send" class="h-5 w-5"></i>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom scrollbar for chat window */
    #chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    #chat-messages::-webkit-scrollbar-thumb {
        background: #C8E6C9;
        border-radius: 10px;
    }
    
    #chat-messages::-webkit-scrollbar-thumb:hover {
        background: #81C784;
    }
    
    /* Typing animation dots */
    .typing-dots span {
        opacity: 0;
        animation: typingDot 1.4s infinite;
        animation-fill-mode: forwards;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typingDot {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // {% if conversation %}
        let conversationId = "{{ conversation.id|default:'' }}";
        conversationId = conversationId === "" ? null : conversationId;
        // {% endif %}
        
        // Scroll to bottom of chat on load
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = userInput.value.trim();
            if (!message) return;
            
            // Add user message to UI immediately
            addMessage(message, 'user', new Date().toTimeString().slice(0, 5));
            userInput.value = '';
            
            // Scroll to bottom
            scrollToBottom();
            
            // Add typing indicator
            addTypingIndicator();
            
            // Send message to server using fetch API
            fetch('{% url "Core:send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.status === 'success') {
                    // Update conversation ID if this is a new conversation
                    if (!conversationId) {
                        conversationId = data.conversation_id;
                        
                        // Update URL to include conversation ID
                        history.pushState(null, '', `/core/chat/${conversationId}/`);
                    }
                    
                    // Add bot response to UI
                    addMessage(data.bot_response, 'bot', data.timestamp);
                    
                    // Scroll to bottom
                    scrollToBottom();
                } else {
                    console.error("Error from server:", data.message);
                    addSystemMessage("Sorry, there was an error processing your request.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                removeTypingIndicator();
                addSystemMessage("Sorry, there was a network error. Please try again.");
            });
        });
        
        function addMessage(text, sender, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start ${sender === 'user' ? 'justify-end' : ''} space-x-3`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                        <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                    </div>
                    <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                        <p class="text-[#1B5E20]">${text}</p>
                        <span class="text-xs text-gray-500 mt-1 block">${time}</span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-[#E3F2FD] rounded-2xl p-4 max-w-[80%]">
                        <p class="text-[#1565C0]">${text}</p>
                        <span class="text-xs text-gray-500 mt-1 block">${time}</span>
                    </div>
                    <div class="flex-shrink-0 bg-[#E3F2FD] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                        <i data-lucide="user" class="h-6 w-6 text-[#1565C0]"></i>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            
            // Initialize Lucide icons in the newly added message
            lucide.createIcons({
                attrs: {
                    class: ["h-6", "w-6"]
                },
                elementQuerySelector: messageDiv
            });
        }
        
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-center my-4';
            messageDiv.innerHTML = `
                <div class="bg-yellow-100 text-yellow-700 rounded-md px-4 py-2 text-sm">
                    ${text}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex items-start space-x-3 typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                    <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                </div>
                <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                    <p class="text-[#1B5E20]"><span class="typing-dots"><span>.</span><span>.</span><span>.</span></span></p>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
            
            // Initialize Lucide icons in the typing indicator
            lucide.createIcons({
                attrs: {
                    class: ["h-6", "w-6"]
                },
                elementQuerySelector: typingDiv
            });
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}