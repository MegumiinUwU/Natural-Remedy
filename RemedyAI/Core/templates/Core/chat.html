{% extends 'Core/base_core.html' %}
{% load static %}

{% block core_content %}
<div class="flex flex-col h-[calc(100vh-260px)]">
    <div class="flex-shrink-0 border-b border-gray-100 pb-4 mb-4">
        <h5 class="text-xl font-bold text-[#1B5E20]">{% if is_new %}New Conversation{% else %}{{ conversation.title }}{% endif %}</h5>
    </div>
    
    <div class="flex-1 overflow-y-auto mb-4 pr-2 space-y-6" id="chat-messages">
        {% if is_new %}
            <!-- Welcome message -->
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                    <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                </div>
                <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                    <p class="text-[#1B5E20]">Hello! I'm your Natural Remedy Assistant. How can I help you today?</p>
                    <p class="text-[#388E3C] mt-2">You can describe your symptoms or ask about natural remedies, and I'll suggest appropriate herbs and treatments.</p>
                    <p class="text-[#1B5E20] mt-4">Let's get started with your personalized experience!</p>
                </div>
            </div>
        {% else %}
            {% for message in messages %}
                <div class="flex items-start {% if message.sender == 'user' %}justify-end{% endif %} space-x-3">
                    {% if message.sender == 'bot' %}
                        <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                            <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                        </div>
                        <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                            <p class="text-[#1B5E20]">{{ message.content }}</p>
                            <span class="text-xs text-gray-500 mt-1 block">{{ message.timestamp|time:"H:i" }}</span>
                        </div>
                    {% else %}
                        <div class="bg-[#E3F2FD] rounded-2xl p-4 max-w-[80%]">
                            <p class="text-[#1565C0]">{{ message.content }}</p>
                            <span class="text-xs text-gray-500 mt-1 block">{{ message.timestamp|time:"H:i" }}</span>
                        </div>
                        <div class="flex-shrink-0 bg-[#E3F2FD] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                            <i data-lucide="user" class="h-6 w-6 text-[#1565C0]"></i>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    </div>
    
    <div class="flex-shrink-0 border-t border-gray-100 pt-4 mt-auto">
        <form id="chat-form" class="flex items-center gap-2">
            {% csrf_token %}
            <div class="relative flex-1">
                <input type="text" id="user-input" class="w-full px-5 py-3 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#43A047] pr-12" 
                       placeholder="Type your message here..." required>
                <button type="submit" class="absolute right-1 top-1/2 transform -translate-y-1/2 bg-[#43A047] text-white p-2 rounded-full hover:bg-[#388E3C] transition">
                    <i data-lucide="send" class="h-5 w-5"></i>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom scrollbar for chat window */
    #chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    #chat-messages::-webkit-scrollbar-thumb {
        background: #C8E6C9;
        border-radius: 10px;
    }
    
    #chat-messages::-webkit-scrollbar-thumb:hover {
        background: #81C784;
    }
    
    /* Typing animation dots */
    .typing-dots span {
        opacity: 0;
        animation: typingDot 1.4s infinite;
        animation-fill-mode: forwards;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typingDot {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');

        function startPersonalization() {
            const questions = [
                { question: "What is your age?", type: "input", placeholder: "Enter your age" },
                { question: "What is your height (in cm)?", type: "input", placeholder: "Enter your height" },
                { question: "What is your weight (in kg)?", type: "input", placeholder: "Enter your weight" },
                { question: "What is your primary wellness goal?", options: ["Stress Relief", "Better Sleep", "Digestive Health", "Pain Relief"] },
                { question: "Do you have any known allergies?", options: ["None", "Pollen", "Nuts", "Other"] }
            ];

            let currentQuestionIndex = 0;

            function askNextQuestion() {
                if (currentQuestionIndex < questions.length) {
                    const currentQuestion = questions[currentQuestionIndex];
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'flex items-start space-x-3';

                    if (currentQuestion.type === "input") {
                        questionDiv.innerHTML = `
                            <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                                <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                            </div>
                            <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                                <p class="text-[#1B5E20]">${currentQuestion.question}</p>
                                <input type="text" class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="${currentQuestion.placeholder}" id="user-input-${currentQuestionIndex}">
                                <button class='mt-4 bg-[#43A047] text-white px-4 py-2 rounded-md shadow-md hover:bg-[#388E3C] transition' id='submit-input-${currentQuestionIndex}'>Submit</button>
                            </div>
                        `;

                        chatMessages.appendChild(questionDiv);

                        document.getElementById(`submit-input-${currentQuestionIndex}`).addEventListener('click', function() {
                            const userInput = document.getElementById(`user-input-${currentQuestionIndex}`).value;
                            if (userInput.trim()) {
                                addMessage(userInput, 'user', new Date().toTimeString().slice(0, 5));
                                currentQuestionIndex++;
                                askNextQuestion();
                            }
                        });
                    } else {
                        questionDiv.innerHTML = `
                            <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                                <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                            </div>
                            <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                                <p class="text-[#1B5E20]">${currentQuestion.question}</p>
                                <div class="flex gap-4 mt-4">
                                    ${currentQuestion.options.map(option => `<button class='option-btn bg-[#43A047] text-white px-4 py-2 rounded-md shadow-md hover:bg-[#388E3C] transition'>${option}</button>`).join('')}
                                </div>
                            </div>
                        `;

                        chatMessages.appendChild(questionDiv);

                        const optionButtons = questionDiv.querySelectorAll('.option-btn');
                        optionButtons.forEach(button => {
                            button.addEventListener('click', function() {
                                addMessage(button.textContent, 'user', new Date().toTimeString().slice(0, 5));
                                currentQuestionIndex++;
                                askNextQuestion();
                            });
                        });
                    }

                    scrollToBottom();
                } else {
                    addMessage("Thank you for providing your details!", 'bot', new Date().toTimeString().slice(0, 5));

                    setTimeout(() => {
                        const finalQuestionDiv = document.createElement('div');
                        finalQuestionDiv.className = 'flex items-start space-x-3';
                        finalQuestionDiv.innerHTML = `
                            <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                                <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                            </div>
                            <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                                <p class="text-[#1B5E20]">Would you like to stay as a guest or have a more personalized experience?</p>
                                <div class="flex gap-4 mt-4">
                                    <button id="guest-option" class="flex items-center gap-2 bg-[#43A047] text-white px-4 py-2 rounded-md shadow-md hover:bg-[#388E3C] transition">
                                        <i data-lucide="user" class="h-5 w-5"></i>
                                        <span>Stay as Guest</span>
                                    </button>
                                    <button id="personalized-option" class="flex items-center gap-2 bg-[#43A047] text-white px-4 py-2 rounded-md shadow-md hover:bg-[#388E3C] transition">
                                        <i data-lucide="user-check" class="h-5 w-5"></i>
                                        <span>Personalized</span>
                                    </button>
                                </div>
                            </div>
                        `;

                        chatMessages.appendChild(finalQuestionDiv);

                        document.getElementById('guest-option').addEventListener('click', function() {
                            addMessage("You chose to stay as a guest. Your data has been saved.", 'bot', new Date().toTimeString().slice(0, 5));
                            saveDataToSession();
                            setTimeout(() => {
                                chatMessages.innerHTML = '';
                                addMessage("Your chat has been cleared. Feel free to ask more questions!", 'bot', new Date().toTimeString().slice(0, 5));
                            }, 2000);
                        });

                        document.getElementById('personalized-option').addEventListener('click', function() {
                            addMessage("Redirecting you to the registration page for a personalized experience.", 'bot', new Date().toTimeString().slice(0, 5));
                            setTimeout(() => {
                                window.location.href = '/register/';
                            }, 2000);
                        });

                        scrollToBottom();
                    }, 1000);
                }
            }

            askNextQuestion();
        }

        function saveDataToSession() {
            const sessionData = {};
            document.querySelectorAll('input').forEach(input => {
                sessionData[input.placeholder] = input.value;
            });
            document.cookie = `user_data=${JSON.stringify(sessionData)}; path=/;`;
        }

        startPersonalization();

        function addMessage(text, sender, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start ${sender === 'user' ? 'justify-end' : ''} space-x-3`;

            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 bg-[#E8F5E9] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                        <i data-lucide="bot" class="h-6 w-6 text-[#2E7D32]"></i>
                    </div>
                    <div class="bg-[#E8F5E9] rounded-2xl p-4 max-w-[80%]">
                        <p class="text-[#1B5E20]">${text}</p>
                        <span class="text-xs text-gray-500 mt-1 block">${time}</span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-[#E3F2FD] rounded-2xl p-4 max-w-[80%]">
                        <p class="text-[#1565C0]">${text}</p>
                        <span class="text-xs text-gray-500 mt-1 block">${time}</span>
                    </div>
                    <div class="flex-shrink-0 bg-[#E3F2FD] rounded-full p-2 h-10 w-10 flex items-center justify-center">
                        <i data-lucide="user" class="h-6 w-6 text-[#1565C0]"></i>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);

            lucide.createIcons({
                attrs: {
                    class: ["h-6", "w-6"]
                },
                elementQuerySelector: messageDiv
            });
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}